const e="https://api.pixelplush.dev/v1";let t="Pixel Avalanche",a={},o={},n="",r=1920,s=1080,i=.5,l=!1;function c(e){return Math.floor(Math.random()*Math.floor(e))}async function p(e){return await fetch("https://id.twitch.tv/oauth2/validate",{headers:{Authorization:`OAuth ${e}`}}).then((e=>e.json())).catch((e=>({error:e})))}async function d(e){return await fetch(`https://api.pixelplush.dev/v1/auth/refresh?token=${e}`).then((e=>e.json())).catch((e=>({error:e})))}window.setupGame=function(e,l,c){t=e,a=l,o=c,n=a.path||"",o.clouds=void 0===o.clouds||null===o.clouds?!o.overlay:"true"===o.clouds,i=void 0===o.volume||null===o.volume?0:parseInt(o.volume)/100,r=Math.min(window.innerWidth,1920),s=Math.min(window.innerHeight,1080)},window.WebFontConfig={custom:{families:["Pixeltype"]},active(){!async function(){try{const t=(await fetch(`${n}/assets/shamelist.txt`).then((e=>e.text()))).split(",").map((e=>e.trim().toLowerCase()));if(o.channel&&t&&t.includes(o.channel.toLowerCase())&&(console.log("This channel has been blocked for violating the PixelPlush Terms of Service."),f=!1),o.oauth&&(o.oauth=await async function(e,t){const a=localStorage.getItem("pixelplush_token"),o=localStorage.getItem("pixelplush_refresh");if(a){const e=await p(a);if(console.log("stored access token",e),e&&e.user_id&&e.scopes&&["user:read:email","chat:read","chat:edit","channel:manage:redemptions","channel:read:redemptions"].every((t=>e.scopes.includes(t))))return a}if(o){const e=await d(o);if(console.log("stored refresh token",e),e&&e.access_token&&e.scope&&["user:read:email","chat:read","chat:edit","channel:manage:redemptions","channel:read:redemptions"].every((t=>e.scope.includes(t))))return localStorage.setItem("pixelplush_token",e.access_token),localStorage.setItem("pixelplush_refresh",e.refresh_token),e.access_token}const n=await p(e);if(console.log("provided access token",n),n&&n.user_id&&n.scopes&&["user:read:email","chat:read","chat:edit","channel:manage:redemptions","channel:read:redemptions"].every((e=>n.scopes.includes(e))))return localStorage.setItem("pixelplush_token",e),localStorage.setItem("pixelplush_refresh",t),e;if(t){const e=await d(t);if(console.log("provided refresh token",e),e&&e.access_token&&e.scope&&["user:read:email","chat:read","chat:edit","channel:manage:redemptions","channel:read:redemptions"].every((t=>e.scope.includes(t))))return localStorage.setItem("pixelplush_token",e.access_token),localStorage.setItem("pixelplush_refresh",e.refresh_token),e.access_token}return console.log("no valid tokens"),null}(o.oauth.replace("oauth:",""),o.refreshToken)),a.requires)try{if(account=await fetch(`${e}/accounts`,{headers:{Twitch:o.oauth?o.oauth.replace("oauth:",""):void 0}}).then((e=>e.json())),console.log(account),account.error)throw"Login Error";if(!account.owned.includes(a.requires))throw"Item not owned"}catch(e){return void console.log("Auth Validate Failed",e)}}catch(e){console.log(e)}"maaya"===o.channel.toLowerCase()&&(l=!0);Unicorn.Create("unicorn-display",{width:r,height:s,background:"transparent",init:K,update:Q,channel:o.channel,username:o.oauth?o.channel:void 0,password:o.oauth,onCommand:v,onChat:_,screenWalls:!1,gravity:{x:0,y:1}}),ComfyJS.onCheer=U,ComfyJS.onConnected=async(e,t,n)=>{if(n){!function(){if(I=a.target_width||368,k=o.rightToLeft?r-(I/2+.82*r):I/2+.82*r,w=s-47+(a.target_offset||0),Array.isArray(a.target)){A=0,L=[];for(let e=0;e<a.target.length;e++){let t=Unicorn.AddBacklay("target"+e,"target"+e,k,w,{scale:{x:2,y:2}});t.zIndex=10,t.anchor.set(.5),t.visible=!1,L.push(t)}L[A].visible=!0,o.hideTilRoll||setInterval((()=>{L[A].visible=!1,A=(A+1)%L.length,L[A].visible=!0}),60)}else L=Unicorn.AddBacklay("target","target",k,w,{scale:{x:2,y:2}}),L.zIndex=10,L.anchor.set(.5);a.target_front&&(T=Unicorn.AddOverlay("target_front","target_front",k,w,{scale:{x:2,y:2}}),T.anchor.set(.5));if(o.clouds)for(let e=0;e<11;e++){m++;let e=a.clouds[c(a.clouds.length)],t=Unicorn.AddOverlay("cloud_"+m,e,c(r),c(500),{scale:{x:3,y:3}});t.alpha=o.overlay?.5:.9,t.anchor.set(.5),t.speed=.01+.1*Math.random(),t.zIndex=t.speed,F.push(t)}o.hideTilRoll&&(F.forEach((e=>e.visible=!1)),Array.isArray(a.target)?L.forEach((e=>{e.visible=!1})):L.visible=!1,T&&(T.visible=!1),X.forEach((e=>e.visible=!1)),J.visible=!1,M.visible=!1);o.defaultCountdown&&parseInt(o.defaultCountdown)&&(b=!0)}();let e=await u();0!==e&&(h=e.session,setInterval((()=>{u()}),6e4))}}}()}},function(){const e=document.createElement("script");e.src=("https:"===document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js",e.type="text/javascript",e.async="true";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();var h="",f=!0;async function u(){let a=Object.keys(E).length;return fetch(`${e}/analytics/heartbeat`,{method:"POST",body:JSON.stringify({session:h,game:"hillroll",theme:t,channel:o.channel,players:Object.keys(E),count:a})}).then((e=>e.json()))}function y(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}}let m=0,g=!0,x=[],b=!1;async function v(e,t,n,r,s){if(document.hidden)return;if(!r.broadcaster&&!r.mod||"resethill"!==t&&"resetrace"!==t||location.reload(),!r.broadcaster&&!r.mod||"queuehill"!==t&&"queuerace"!==t||(b=!b,Object.keys(E).forEach((e=>{Unicorn.RemoveBacklay("para_"+e),Unicorn.RemoveBacklay("petpara_"+e),Unicorn.RemoveObject("player_"+e),Unicorn.RemoveObject("pet_"+e),Unicorn.RemoveText("name_"+e),Unicorn.RemoveBacklay("end_"+e),Unicorn.RemoveBacklay("petend_"+e),Unicorn.RemoveText(e+"_points"),delete E[e]})),$.x=-1e3,$.y=-1e3,S&&clearTimeout(S),b?ComfyJS.Say("/me The Hill Rolling Race is starting! Type !hill to join. Mods can use !starthill [time] to change the countdown."):ComfyJS.Say("/me The race has been cancelled.")),(r.broadcaster||r.mod)&&("starthill"===t||"startrace"===t)&&b){let e=parseInt(n.split(" "));e>0?O=1e3*e:D()}if((r.broadcaster||r.mod)&&("testhill"===t||"testrace"===t))for(var i=0;i<50;i++)m++,b?x.push({username:"test"+m,name:"test_"+m,color:s.userColor||"#ffffff",message:n,emote:"",emoji:"",extra:s}):G("test"+m,"test_"+m,s.userColor||"#ffffff",n,a.parachutes[c(a.parachutes.length)],"","",s);let l=!1;if(o.command&&t===o.command&&(l=!0),o.command||"hill"!==t&&"rolling"!==t&&"race"!==t||(l=!0),f){if(l){g&&0===O&&(O=1e3*parseInt(o.defaultCountdown)),g&&o.hideTilRoll&&(g=!1,F.forEach((e=>e.visible=!0)),Array.isArray(L)?(L[A].visible=!0,setInterval((()=>{L[A].visible=!1,A=(A+1)%L.length,L[A].visible=!0}),60)):L.visible=!0,T&&(T.visible=!0),X.forEach((e=>e.visible=!0)),J.visible=!0,M.visible=!0);const t=twemoji.parse(n,{assetType:"png"});!s.messageEmotes&&t.length>0?b&&!P?x.push({username:s.username,name:e,color:s.userColor||"#ffffff",message:n,emote:"",emoji:t[0].url,extra:s}):G(s.username,e,s.userColor||"#ffffff",n,a.parachutes[c(a.parachutes.length)],"",t[0].url,s):b&&!P?x.push({username:s.username,name:e,color:s.userColor||"#ffffff",message:n,emote:s.messageEmotes?Object.keys(s.messageEmotes)[0]:"",emoji:"",extra:s}):G(s.username,e,s.userColor||"#ffffff",n,a.parachutes[c(a.parachutes.length)],s.messageEmotes?Object.keys(s.messageEmotes)[0]:"","",s)}}else l&&o.oauth&&ComfyJS.Say("Hill Rolling Race is disabled in this channel for violating the Terms of Service. To re-enable the game, please contact the PixelPlush team on Discord.")}function _(e,t,a,o,n){document.hidden}function U(e,t,a,o,n){if(!document.hidden&&f)for(let e=0;e<5;e++)V(t)}let $,S=null,I=368,k=0,w=0,L=null,T=null,A=0,E={},j=[],M=null,O=0,P=!1,C=0,z="",R={},B={},F=[],X=[],J=null,N=[],W=null,q=0;function D(){O=0,Unicorn.PlaySound("sfx-parachute-drop",{volume:i}),async function(e){q++;let t=null,o=0;o=e<100?0:e<1e3?1:e<5e3?2:e<1e4?3:e<1e5?4:5;let n=3;a.dropletSizes&&(n*=a.dropletSizes[o]);n*=1.5;let r=a.droplets[o];Array.isArray(a.droplets[o])&&(r=a.droplets[o][c(a.droplets[o].length)]);t=Unicorn.AddObject("cheese_"+q,{type:"circle",sprite:r,scale:{x:1*n,y:1*n},x:c(20),y:-50-c(50),z:100,radius:1*(o/5*4+20)}),t.restitution=0,t.friction=2,t.frictionStatic=0,t.frictionAir=0,t.torque=0+c(2),t.rotationOffset=Math.random()*Math.PI,Unicorn.SetVelocity("droplet_"+q,c(24)-12,0)}(1e3),l?(x.forEach((e=>{"maaya"===e.username&&G(e.username,e.name,e.color,e.message,a.parachutes[c(a.parachutes.length)],e.emote,e.emoji,e.extra)})),setTimeout((()=>{P=!0,setTimeout((()=>{y(x),x.forEach((e=>{"maaya"!==e.username&&G(e.username,e.name,e.color,e.message,a.parachutes[c(a.parachutes.length)],e.emote,e.emoji,e.extra)})),x=[]}),1e3)}),5e3)):(P=!0,setTimeout((()=>{y(x),x.forEach((e=>{G(e.username,e.name,e.color,e.message,a.parachutes[c(a.parachutes.length)],e.emote,e.emoji,e.extra)})),x=[]}),1e3))}function Y(e,t,a,o,n,r=""){q++;let s=Math.min(Math.max(1,n),100);Unicorn.AddParticles("Splash_"+q,{blendMode:PIXI.BLEND_MODES.DEFAULT,shape:"cone",angle:-Math.PI/2,spread:Math.PI/2,startColor:e,endColor:t,intensity:s,minSpeed:.05,maxSpeed:.25,gravityX:0,gravityY:3.5,fadeOut:!0,decay:1,image:r||void 0},a,o),function(e,t=2e3){setTimeout((()=>{Unicorn.RemoveParticles(e)}),t)}("Splash_"+q,150)}function H(e,t,o,n=""){const r=a.target_boosh_scale||2;a.target_boosh.forEach(((a,o)=>{for(let a=0;a<c(5);a++){q++;let o=Unicorn.AddBacklay("boosh_"+q,"target_boosh"+a,e,t+10,{scale:{x:r,y:r}});o.zIndex=11,o.vX=c(50)-25,o.vY=-350+c(100),o.anchor.set(.5),N.push(o)}}))}async function G(t,s,i="#ffffff",l,p,d="",h="",f){const u=4/60;if(!E[t]){E[t]={};let g=null,x=null,b=null,v=tinycolor(i),_={};try{let a=await fetch(`${e}/accounts/twitch/design?username=${t}`).then((e=>e.json()));a&&(_=a.style||{})}catch(e){console.log(e)}if(_.pet&&_.pet.id&&"pet_none"!==_.pet.id&&(a.pets||(a.pets={}),x=_.pet.id.replace("pet_",""),!a.pets[x])){a.pets[x]={path:_.pet.path,minIdle:_.pet.minIdle,maxIdle:_.pet.maxIdle};for(let e=0;e<10;e++){let t=_.pet.path+"_front";Unicorn.Load(t+e,`${n}/assets/pets/${x}/${t}/${t}${e+1}.png`)}}if(d){if(!R[d]){R[d]=!0;var y=`https://static-cdn.jtvnw.net/emoticons/v1/${d}/2.0`;return Unicorn.Load(`emote_${d}`,y),void setTimeout((()=>{delete E[t],G(t,s,i,l,p,d,h,f)}),500)}g=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:1,y:1},animations:{front:{framerate:u,frames:[`emote_${d}`],loop:!0}},x:o.rightToLeft?r-c(20):c(20),y:-50-c(50),z:100,radius:24}),g.endImage=`emote_${d}`,g.endScale=1}else if(h){if(!B[h])return B[h]=!0,Unicorn.Load(`emoji_${h}`,h),void setTimeout((()=>{delete E[t],G(t,s,i,l,p,d,h,f)}),500);g=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:.6,y:.6},animations:{front:{framerate:u,frames:[`emoji_${h}`],loop:!0}},x:o.rightToLeft?r-c(20):c(20),y:-50-c(50),z:100,radius:24}),g.endImage=`emoji_${h}`,g.endScale=.6}else{if(!a.characters[l])if(_.character&&_.character.id){if(!a.characters[_.character.id]){a.characters[_.character.id]=_.character.path;for(let e=0;e<10;e++){let t=a.characters[_.character.id];Unicorn.Load(`${_.character.id}_${e}`,`${n}/assets/characters/${_.character.id}/${t}_front/${t}_front${e+1}.png`)}}l=_.character.id}else l=a.playable[Math.floor(a.playable.length*Math.random())];if(g=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:u,frames:[...Array(10).keys()].map((e=>`${l}_${e}`)),loop:!0}},x:o.rightToLeft?r-c(20):c(20),y:-50-c(50),z:100,radius:24}),g.endImage=`${l}_0`,g.endScale=2,"boybear"===l||"girlbear"===l){var m=PIXI.utils.string2hex(v.brighten(50).toHexString());g.animations.front.tint=m}}if(x){let e={front:[]};for(let t=0;t<10;t++)Object.keys(e).forEach((o=>{e[o].push(a.pets[x].path+"_"+o+t)}));b=Unicorn.AddObject("pet_"+t,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:u,frames:e.front,loop:!0}},x:-1e3,y:-1e3,z:200,radius:16,isStatic:!0}),b.isSensor=!0}let U=Unicorn.AddBacklay("para_"+t,p,{scale:{x:3,y:3},x:50,y:0,z:50});U.scale.x=0,U.scale.y=0,U.anchor.set(.5,.9);let $=Unicorn.AddText("name_"+t,s,-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:34,fontWeight:400,fill:i,lineJoin:"round",stroke:tinycolor.isReadable(v.toString(),"#000000")?"#000000":"#ffffff",strokeThickness:6});$.anchor.set(.5);let I=Unicorn.AddText(t+"_points","",-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:34,fontWeight:400,fill:"#ffd700",lineJoin:"round",stroke:"#000000",strokeThickness:6});I.anchor.set(.5);let k=null;x&&(k=Unicorn.AddBacklay("petpara_"+t,p,{scale:{x:1,y:1},x:50,y:0,z:150}),k.scale.x=0,k.scale.y=0,k.anchor.set(.5,.5)),g.restitution=1,g.frictionStatic=0,g.frictionAir=0,g.torque=0+c(3),g.rotationOffset=Math.random()*Math.PI,E[t]={parachute:U,player:g,pet:b,petPara:k,petType:x,petOffset:10*Math.random(),label:$,scoreLabel:I},f&&(E[t].userId=f.userId,E[t].name=f.displayName||f.username),S&&clearTimeout(S),S=setTimeout((()=>{location.reload()}),parseInt(o.cooldown||"90000"))}}async function V(e){if(!o.droplets)return;q++;let t=null,n=0;n=e<100?0:e<1e3?1:e<5e3?2:e<1e4?3:e<1e5?4:5;let s=3;a.dropletSizes&&(s*=a.dropletSizes[n]);let i=a.droplets[n];Array.isArray(a.droplets[n])&&(i=a.droplets[n][c(a.droplets[n].length)]),t=Unicorn.AddObject("droplet_"+q,{type:"circle",sprite:i,scale:{x:1*s,y:1*s},x:c(r),y:-100-c(50),z:100,radius:1*(n/5*4+20)}),t.restitution=1,t.friction=.5*(5-n),t.frictionStatic=0,t.frictionAir=0,t.torque=-1+c(2),t.rotationOffset=Math.random()*Math.PI,Unicorn.SetVelocity("droplet_"+q,c(24)-12,0),setTimeout((()=>{Unicorn.RemoveObject(t.label)}),3e4)}function K(){if(PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,Unicorn.Load("map",`${n}/assets/${a.bg}.png`),!o.overlay){var e=Unicorn.AddBacklay("map","map",0,s-1080);e.scale.x=3,e.scale.y=3}if(Array.isArray(a.target)){a.target.map(((e,t)=>Unicorn.Load("target"+t,`${n}/assets/${e}.png`)))}else{Unicorn.Load("target",`${n}/assets/${a.target}.png`)}a.target_front&&Unicorn.Load("target_front",`${n}/assets/${a.target_front}.png`),a.target_boosh&&a.target_boosh.forEach(((e,t)=>{Unicorn.Load("target_boosh"+t,`${n}/assets/${e}.png`)})),Unicorn.Load("star",`${n}/assets/icons/star.png`),$=Unicorn.AddOverlay("star","star",-1e3,-1e3,{scale:{x:3,y:3}}),$.anchor.set(.5),a.parachutes.forEach((e=>Unicorn.Load(e,`${n}/assets/${e}.png`))),Object.keys(a.characters).forEach((e=>{for(let t=0;t<10;t++){let o=a.characters[e];Unicorn.Load(`${e}_${t}`,`${n}/assets/characters/${e}/${o}_front/${o}_front${t+1}.png`)}})),a.clouds.forEach((e=>Unicorn.Load(e,`${n}/assets/${e}.png`))),a.droplets.forEach((e=>{Array.isArray(e)?e.forEach((e=>Unicorn.Load(e,`${n}/assets/${e}.png`))):Unicorn.Load(e,`${n}/assets/${e}.png`)})),a.target_sound&&Unicorn.Load("sfx-target-drop",`${n}/assets/${a.target_sound}`),Unicorn.Load("sfx-parachute-drop",`${n}/assets/${a.drop_sound}`),Unicorn.Load("sfx-parachute-flap",`${n}/assets/${a.parachute_sound}`);const t=a.segments;t.forEach(((e,t)=>{Unicorn.Load(`ground_segment_${t}`,`https://www.pixelplush.dev/assets/${e}.png`)})),Unicorn.AddObject("WallLeft",{type:"rectangle",x:-200,y:0,width:400,height:2*s,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("WallRight",{type:"rectangle",x:r+200,y:0,width:400,height:2*s,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("WallBottom",{type:"rectangle",x:.5*r,y:s+100,width:r,height:200,isStatic:!0}).sprite.visible=!1;const i=1.1*s/r;let l=0,p=0,d=[{x:o.rightToLeft?r:0,y:100}],h=0;for(let e=30;e<r;e+=30){h++;let a=e*i-Math.min(100,5*h)+c(50),n=Math.atan2(a-p,30),s=Math.sqrt((a-p)**2+900);d.push({x:o.rightToLeft?r-e:e,y:100+a}),Unicorn.AddObject("Ground_"+e,{type:"rectangle",x:o.rightToLeft?r-(.5*(e-l)+l):.5*(e-l)+l,y:120+.5*(a-p)+p,width:s,height:40,angle:o.rightToLeft?-n:n,isStatic:!0,color:3355443}).sprite.visible=!1;let f=Unicorn.AddOverlay("ground_segment_"+e,`ground_segment_${c(t.length)}`,o.rightToLeft?r-(.5*(e-l)+l):.5*(e-l)+l,100+.5*(a-p)+p,{scale:{x:o.rightToLeft?-s/20:s/20,y:s/20}});f.rotation=o.rightToLeft?-n:n,f.anchor.set(.5,1),f.filters=[new PIXI.filters.NoiseFilter(.1)],o.hideTilRoll&&(f.visible=!1),X.push(f),l=e,p=a}d.push({x:o.rightToLeft?r:0,y:s+100}),d.reverse();const f=new PIXI.Graphics;f.beginFill(a.groundColor),f.drawPolygon(d.map((e=>new PIXI.Point(e.x,e.y)))),f.endFill(),f.filters=[new PIXI.filters.NoiseFilter(.1)],groupOverlay.addChild(f),o.hideTilRoll&&(f.visible=!1),J=f,Matter.Events.on(physics,"beforeUpdate",(function(e){})),Matter.Events.on(physics,"afterUpdate",(function(e){for(var t in E)E[t].pet&&(E[t].pet.angle=E[t].player.angle,E[t].pet.position.x=Math.max(10,Math.min(r-10,E[t].player.position.x+E[t].petOffset)),E[t].pet.position.y=E[t].player.position.y+10)})),M=Unicorn.AddText("countdown_text","!hill to roll",r/2,.025*s,{fontFamily:"Pixeltype",fontSize:80,fontWeight:"bold",fill:0,lineJoin:"round",stroke:"#ffffff",strokeThickness:6}),M.style.align="center",M.anchor.set(.5,0),(o.hideInstructions||o.hideTime)&&(M.text="")}function Q(e,t){for(var n in P&&j.length<Object.keys(E).length&&(C+=t,o.hideTime||(M.text=(C/1e3).toFixed(3)+"s")),O>0&&(O-=t,o.hideTime?M.text="":o.hideInstructions?M.text=`Starting in ${Math.round(O/1e3)}s`:M.text=`!hill to join\n${Math.round(O/1e3)}s`,O<=0&&(o.hideTime||(M.text="0.000s"),D())),E)if(E[n].player)if(E[n].isLanded){if(b){let e=n===z?1:.3;E[n].end.alpha=e,E[n].label.alpha=Math.round(e),E[n].pet&&(E[n].petEnd.alpha=e)}E[n].scoreLabel.tint=E[n].label.tint=n===z?16777215:3355443,n===z?(E[n].end.zIndex=E[n].scoreLabel.zIndex=E[n].label.zIndex=9e3,E[n].pet&&(E[n].pet.zIndex=9001),E[n].label.position.x=E[n].player.position.x,E[n].label.position.y=E[n].player.position.y-80,E[n].scoreLabel.position.x=E[n].label.position.x+15,E[n].scoreLabel.position.y=E[n].label.position.y-30,E[n].label.style.fontSize=40,E[n].scoreLabel.style.fontSize=40,$.x=E[n].scoreLabel.x-E[n].scoreLabel.width/2-15,$.y=E[n].scoreLabel.y-5):(E[n].label.position.x=E[n].player.position.x,E[n].label.position.y=E[n].player.position.y-60,E[n].scoreLabel.position.y=E[n].label.position.y-30,E[n].scoreLabel.alpha=0,E[n].label.style.fontSize=34,E[n].scoreLabel.style.fontSize=34)}else{if(E[n].pet&&(E[n].pet.position.x=Math.max(20,Math.min(r-20,E[n].player.position.x+E[n].petOffset)),E[n].pet.position.y=E[n].player.position.y+20,E[n].petPara.position.x=E[n].pet.position.x,E[n].petPara.position.y=E[n].pet.position.y-30),E[n].player.position.y>s-46-50+(a.target_y_offset||0)){E[n].isLanded=!0,E[n].parachute.scale.x=E[n].parachute.scale.y=0,E[n].pet&&(E[n].petPara.scale.x=E[n].petPara.scale.y=0);let e=Unicorn.AddBacklay("end_"+n,E[n].player.endImage,E[n].player.position.x,E[n].player.position.y,{scale:{x:E[n].player.endScale,y:E[n].player.endScale}});if(E[n].player.animations&&(e.tint=E[n].player.animations.front.tint),e.anchor.set(.5),e.zIndex=20,E[n].player.isStatic=!0,b&&(j.push(n),E[n].score=C,E[n].rank=j.length),b?e.alpha=E[n].score>0?1:.3:(W&&(W.end.alpha=.3,W.petEnd&&(W.petEnd.alpha=.3)),e.alpha=1,W=E[n]),E[n].end=e,E[n].pet){let e=Unicorn.AddBacklay("petend_"+n,`${E[n].petType}_front0`,E[n].pet.position.x,E[n].pet.position.y,{scale:{x:2,y:2}});E[n].pet.animations&&(e.tint=E[n].pet.animations.front.tint),e.anchor.set(.5),e.zIndex=30,E[n].pet.isStatic=!0,b&&(e.alpha=E[n].score>0?1:.3),E[n].petEnd=e}if(a.target_particles&&Y(a.target_particles[0],a.target_particles[1],E[n].player.position.x,E[n].player.position.y+40,10),a.target_boosh&&H(E[n].player.position.x,E[n].player.position.y+40),a.target_sound&&Unicorn.PlaySound("sfx-target-drop",{volume:i}),console.log((C/1e3).toFixed(3)+"s",n,"finished",E[n].rank),b&&1===E[n].rank&&(E[n].scoreLabel.x=E[n].label.position.x,E[n].scoreLabel.y=E[n].label.position.y-30,E[n].scoreLabel.text=(C/1e3).toFixed(3)+"s",z=n),b&&E[n].rank<=(o.winnerCount?parseInt(o.winnerCount):10)&&o.messageFormat){let e=o.messageFormat.replace("USERNAME",E[n].name).replace("RANK",E[n].rank).replace("TIME",(C/1e3).toFixed(3)+"s");setTimeout((()=>{ComfyJS.Say(e)}),5e3)}E[n].label.alpha=1===E[n].rank?1:.3,Unicorn.RemoveObject(E[n].player.label),Unicorn.RemoveBacklay("para_"+n),E[n].pet&&(Unicorn.RemoveObject(E[n].pet.label),Unicorn.RemoveBacklay("petpara_"+n))}else E[n].player.position.y<.5*-s||(E[n].parachute.scale.x=E[n].parachute.scale.y=0,E[n].pet&&(E[n].petPara.scale.x=E[n].petPara.scale.y=0));E[n].label.position.x=E[n].player.position.x,E[n].label.position.y=E[n].player.position.y-60}F.forEach(((e,a)=>{e.x-=t*e.speed,e.x+e.width/2<=0&&(e.x=r+e.width/2,e.y=c(500),e.speed=.01+.1*Math.random(),e.zIndex=e.speed)})),N.forEach((e=>{(e.vY<0||e.y<s-20)&&(e.x+=t/1e3*e.vX,e.y+=t/1e3*e.vY,e.vY<20&&(e.vY+=t/1e3*200))}))}