const e="https://api.pixelplush.dev/v1";let t="Pixel Avalanche",a={},o={},n="",i=1920,r=1080,s=.5;function l(e){return Math.floor(Math.random()*Math.floor(e))}window.setupGame=function(e,l,c){t=e,a=l,o=c,n=a.path||"",o.clouds=void 0===o.clouds||null===o.clouds?!o.overlay:"true"===o.clouds,s=void 0===o.volume||null===o.volume?0:parseInt(o.volume)/100,i=Math.min(window.innerWidth,1920),r=Math.min(window.innerHeight,1080)},window.WebFontConfig={custom:{families:["Pixeltype"]},active(){!async function(){if(document.hidden)return void document.addEventListener("visibilitychange",(()=>{location.reload()}),!1);try{const e=(await fetch(`${n}/assets/shamelist.txt`).then((e=>e.text()))).split(",").map((e=>e.trim().toLowerCase()));o.channel&&e&&e.includes(o.channel.toLowerCase())&&(console.log("This channel has been blocked for violating the PixelPlush Terms of Service."),p=!1)}catch(e){console.log(e)}Unicorn.Create("unicorn-display",{width:i,height:r,background:"transparent",init:N,update:J,channel:o.channel,username:o.oauth?o.channel:void 0,password:o.oauth,onCommand:y,onChat:m,screenWalls:!1,gravity:{x:0,y:1}}),ComfyJS.onCheer=u,ComfyJS.onConnected=async(n,s,p)=>{if(p){!function(){if(b=a.target_width||368,v=b/2+.82*i,_=r-47+(a.target_offset||0),Array.isArray(a.target)){S=0,$=[];for(let e=0;e<a.target.length;e++){let t=Unicorn.AddBacklay("target"+e,"target"+e,v,_,{scale:{x:2,y:2}});t.zIndex=10,t.anchor.set(.5),t.visible=!1,$.push(t)}$[S].visible=!0,o.hideTilRoll||setInterval((()=>{$[S].visible=!1,S=(S+1)%$.length,$[S].visible=!0}),60)}else $=Unicorn.AddBacklay("target","target",v,_,{scale:{x:2,y:2}}),$.zIndex=10,$.anchor.set(.5);a.target_front&&(U=Unicorn.AddOverlay("target_front","target_front",v,_,{scale:{x:2,y:2}}),U.anchor.set(.5));if(o.clouds)for(let e=0;e<11;e++){d++;let e=a.clouds[l(a.clouds.length)],t=Unicorn.AddOverlay("cloud_"+d,e,l(i),l(500),{scale:{x:3,y:3}});t.alpha=o.overlay?.5:.9,t.anchor.set(.5),t.speed=.01+.1*Math.random(),t.zIndex=t.speed,T.push(t)}o.hideTilRoll&&(T.forEach((e=>e.visible=!1)),Array.isArray(a.target)?$.forEach((e=>{e.visible=!1})):$.visible=!1,U.visible=!1)}();let n=await async function(){let a=Object.keys(A).length;return fetch(`${e}/analytics/heartbeat`,{method:"POST",body:JSON.stringify({session:c,game:"hillroll",theme:t,channel:o.channel,players:Object.keys(A),count:a})}).then((e=>e.json()))}();0!==n&&(c=n.session,setInterval((()=>{}),6e4))}}}()}},function(){const e=document.createElement("script");e.src=("https:"===document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js",e.type="text/javascript",e.async="true";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();var c="",p=!0;let d=0,h=!0,f=[];async function y(e,t,a,n,i){if(document.hidden)return;if(!n.broadcaster&&!n.mod||"resethill"!==t&&"resetrace"!==t||location.reload(),(n.broadcaster||n.mod)&&("starthill"===t||"startrace"===t)){let e=parseInt(a.split(" "));e>0?M=1e3*e:C()}if((n.broadcaster||n.mod)&&("testhill"===t||"testrace"===t))for(var r=0;r<50;r++)d++,f.push({username:"test"+d,name:"test_"+d,color:i.userColor||"#ffffff",message:a,emote:"",emoji:"",extra:i});let s=!1;if(o.command&&t===o.command&&(s=!0),o.command||"hill"!==t&&"rolling"!==t&&"race"!==t||(s=!0),p){if(s){h&&(M=6e4,ComfyJS.Say("The Hill Rolling Race is starting! Type !hill to join. Mods can use !starthill [time] to change the countdown.")),h&&o.hideTilRoll&&(h=!1,T.forEach((e=>e.visible=!0)),Array.isArray($)?($[S].visible=!0,setInterval((()=>{$[S].visible=!1,S=(S+1)%$.length,$[S].visible=!0}),60)):$.visible=!0,U&&(U.visible=!0));const t=twemoji.parse(a,{assetType:"png"});!i.messageEmotes&&t.length>0?f.push({username:i.username,name:e,color:i.userColor||"#ffffff",message:a,emote:"",emoji:t[0].url,extra:i}):f.push({username:i.username,name:e,color:i.userColor||"#ffffff",message:a,emote:i.messageEmotes?Object.keys(i.messageEmotes)[0]:"",emoji:"",extra:i})}}else s&&o.oauth&&ComfyJS.Say("Hill Rolling Race is disabled in this channel for violating the Terms of Service. To re-enable the game, please contact the PixelPlush team on Discord.")}function m(e,t,a,o,n){document.hidden}function u(e,t,a,o,n){if(!document.hidden&&p)for(let e=0;e<5;e++)X(t)}let g,x=null,b=368,v=0,_=0,$=null,U=null,S=0,A={},I=[],L=null,M=0,w=!1,j=0,E="",O={},P={},T=[],k=[],z=0;function C(){M=0,Unicorn.PlaySound("sfx-parachute-drop",{volume:s}),async function(e){z++;let t=null,o=0;o=e<100?0:e<1e3?1:e<5e3?2:e<1e4?3:e<1e5?4:5;let n=3;a.dropletSizes&&(n*=a.dropletSizes[o]);n*=1.5;let i=a.droplets[o];Array.isArray(a.droplets[o])&&(i=a.droplets[o][l(a.droplets[o].length)]);t=Unicorn.AddObject("cheese_"+z,{type:"circle",sprite:i,scale:{x:n,y:n},x:l(20),y:-50-l(50),z:100,radius:o/5*4+20}),t.restitution=0,t.friction=2,t.frictionStatic=0,t.frictionAir=0,t.torque=0+l(2),t.rotationOffset=Math.random()*Math.PI,Unicorn.SetVelocity("droplet_"+z,l(24)-12,0)}(1e3),w=!0,setTimeout((()=>{!function(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}}(f),f.forEach((e=>{B(e.username,e.name,e.color,e.message,a.parachutes[l(a.parachutes.length)],e.emote,e.emoji,e.extra)})),f=[]}),1e3)}function R(e,t,a,o,n,i=""){z++;let r=Math.min(Math.max(1,n),100);Unicorn.AddParticles("Splash_"+z,{blendMode:PIXI.BLEND_MODES.DEFAULT,shape:"cone",angle:-Math.PI/2,spread:Math.PI/2,startColor:e,endColor:t,intensity:r,minSpeed:.05,maxSpeed:.25,gravityX:0,gravityY:3.5,fadeOut:!0,decay:1,image:i||void 0},a,o),function(e,t=2e3){setTimeout((()=>{Unicorn.RemoveParticles(e)}),t)}("Splash_"+z,150)}function F(e,t,o,n=""){const i=a.target_boosh_scale||2;a.target_boosh.forEach(((a,o)=>{for(let a=0;a<l(5);a++){z++;let o=Unicorn.AddBacklay("boosh_"+z,"target_boosh"+a,e,t+10,{scale:{x:i,y:i}});o.zIndex=11,o.vX=l(50)-25,o.vY=-350+l(100),o.anchor.set(.5),k.push(o)}}))}async function B(t,r,s="#ffffff",c,p,d="",h="",f){const y=4/60;if(!A[t]){A[t]={};let g=null,b=null,v=null,_=tinycolor(s),$={};try{let a=await fetch(`${e}/accounts/twitch/design?username=${t}`).then((e=>e.json()));a&&($=a.style||{})}catch(e){console.log(e)}if($.pet&&$.pet.id&&"pet_none"!==$.pet.id&&(a.pets||(a.pets={}),b=$.pet.id.replace("pet_",""),!a.pets[b])){a.pets[b]={path:$.pet.path,minIdle:$.pet.minIdle,maxIdle:$.pet.maxIdle};for(let e=0;e<10;e++){let t=$.pet.path+"_front";Unicorn.Load(t+e,`${n}/assets/pets/${b}/${t}/${t}${e+1}.png`)}}if(d){if(!O[d]){O[d]=!0;var m=`https://static-cdn.jtvnw.net/emoticons/v1/${d}/2.0`;return Unicorn.Load(`emote_${d}`,m),void setTimeout((()=>{delete A[t],B(t,r,s,c,p,d,h,f)}),500)}g=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:1.2,y:1.2},animations:{front:{framerate:y,frames:[`emote_${d}`],loop:!0}},x:l(i),y:-100-l(50),z:100,radius:36}),g.endImage=`emote_${d}`,g.endScale=1.2}else if(h){if(!P[h])return P[h]=!0,Unicorn.Load(`emoji_${h}`,h),void setTimeout((()=>{delete A[t],B(t,r,s,c,p,d,h,f)}),500);g=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:1,y:1},animations:{front:{framerate:y,frames:[`emoji_${h}`],loop:!0}},x:l(i),y:-100-l(50),z:100,radius:36}),g.endImage=`emoji_${h}`,g.endScale=1}else{if(!a.characters[c])if($.character&&$.character.id){if(!a.characters[$.character.id]){a.characters[$.character.id]=$.character.path;for(let e=0;e<10;e++){let t=a.characters[$.character.id];Unicorn.Load(`${$.character.id}_${e}`,`${n}/assets/characters/${$.character.id}/${t}_front/${t}_front${e+1}.png`)}}c=$.character.id}else c=a.playable[Math.floor(a.playable.length*Math.random())];if(g=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:y,frames:[...Array(10).keys()].map((e=>`${c}_${e}`)),loop:!0}},x:l(20),y:-50-l(50),z:100,radius:24}),g.endImage=`${c}_0`,g.endScale=3,"boybear"===c||"girlbear"===c){var u=PIXI.utils.string2hex(_.brighten(50).toHexString());g.animations.front.tint=u}}if(b){let e={front:[]};for(let t=0;t<10;t++)Object.keys(e).forEach((o=>{e[o].push(a.pets[b].path+"_"+o+t)}));v=Unicorn.AddObject("pet_"+t,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:y,frames:e.front,loop:!0}},x:-1e3,y:-1e3,z:200,radius:16,isStatic:!0}),v.isSensor=!0}let U=Unicorn.AddBacklay("para_"+t,p,{scale:{x:3,y:3},x:50,y:0,z:50});U.scale.x=0,U.scale.y=0,U.anchor.set(.5,.9);let S=Unicorn.AddText("name_"+t,r,-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:s,lineJoin:"round",stroke:_.getLuminance()<.6?"#ffffff":"#000000",strokeThickness:6});S.anchor.set(.5);let I=Unicorn.AddText(t+"_points","",-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:"#ffd700",lineJoin:"round",stroke:"#000000",strokeThickness:6});I.anchor.set(.5);let L=null;b&&(L=Unicorn.AddBacklay("petpara_"+t,p,{scale:{x:1,y:1},x:50,y:0,z:150}),L.scale.x=0,L.scale.y=0,L.anchor.set(.5,.5)),g.restitution=1,g.frictionStatic=0,g.frictionAir=0,g.torque=0+l(3),g.rotationOffset=Math.random()*Math.PI,A[t]={parachute:U,player:g,pet:v,petPara:L,petType:b,petOffset:10*Math.random(),label:S,scoreLabel:I},f&&(A[t].userId=f.userId,A[t].name=f.displayName||f.username),x&&clearTimeout(x),x=setTimeout((()=>{location.reload()}),parseInt(o.cooldown||"90000"))}}async function X(e){if(!o.droplets)return;z++;let t=null,n=0;n=e<100?0:e<1e3?1:e<5e3?2:e<1e4?3:e<1e5?4:5;let r=3;a.dropletSizes&&(r*=a.dropletSizes[n]);let s=a.droplets[n];Array.isArray(a.droplets[n])&&(s=a.droplets[n][l(a.droplets[n].length)]),t=Unicorn.AddObject("droplet_"+z,{type:"circle",sprite:s,scale:{x:r,y:r},x:l(i),y:-100-l(50),z:100,radius:n/5*4+20}),t.restitution=1,t.friction=.5*(5-n),t.frictionStatic=0,t.frictionAir=0,t.torque=-1+l(2),t.rotationOffset=Math.random()*Math.PI,Unicorn.SetVelocity("droplet_"+z,l(24)-12,0),setTimeout((()=>{Unicorn.RemoveObject(t.label)}),3e4)}function N(){if(PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,Unicorn.Load("map",`${n}/assets/${a.bg}.png`),!o.overlay){var e=Unicorn.AddBacklay("map","map",0,r-1080);e.scale.x=3,e.scale.y=3}if(Array.isArray(a.target)){a.target.map(((e,t)=>Unicorn.Load("target"+t,`${n}/assets/${e}.png`)))}else{Unicorn.Load("target",`${n}/assets/${a.target}.png`)}a.target_front&&Unicorn.Load("target_front",`${n}/assets/${a.target_front}.png`),a.target_boosh&&a.target_boosh.forEach(((e,t)=>{Unicorn.Load("target_boosh"+t,`${n}/assets/${e}.png`)})),Unicorn.Load("star",`${n}/assets/icons/star.png`),g=Unicorn.AddOverlay("star","star",-1e3,-1e3,{scale:{x:3,y:3}}),g.anchor.set(.5),a.parachutes.forEach((e=>Unicorn.Load(e,`${n}/assets/${e}.png`))),Object.keys(a.characters).forEach((e=>{for(let t=0;t<10;t++){let o=a.characters[e];Unicorn.Load(`${e}_${t}`,`${n}/assets/characters/${e}/${o}_front/${o}_front${t+1}.png`)}})),a.clouds.forEach((e=>Unicorn.Load(e,`${n}/assets/${e}.png`))),a.droplets.forEach((e=>{Array.isArray(e)?e.forEach((e=>Unicorn.Load(e,`${n}/assets/${e}.png`))):Unicorn.Load(e,`${n}/assets/${e}.png`)})),a.target_sound&&Unicorn.Load("sfx-target-drop",`${n}/assets/${a.target_sound}`),Unicorn.Load("sfx-parachute-drop",`${n}/assets/${a.drop_sound}`),Unicorn.Load("sfx-parachute-flap",`${n}/assets/${a.parachute_sound}`);const t=a.segments;t.forEach(((e,t)=>{Unicorn.Load(`ground_segment_${t}`,`https://www.pixelplush.dev/assets/${e}.png`)})),Unicorn.AddObject("WallLeft",{type:"rectangle",x:-200,y:0,width:400,height:2*r,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("WallRight",{type:"rectangle",x:i+200,y:0,width:400,height:2*r,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("WallBottom",{type:"rectangle",x:.5*i,y:r+100,width:i,height:200,isStatic:!0}).sprite.visible=!1;const s=1.1*r/i;let c=0,p=0,d=[{x:0,y:100}],h=0;for(let e=30;e<i;e+=30){h++;let a=e*s-Math.min(100,5*h)+l(50),o=Math.atan2(a-p,30),n=Math.sqrt((a-p)**2+900);d.push({x:e,y:100+a});Unicorn.AddObject("Ground_"+e,{type:"rectangle",x:.5*(e-c)+c,y:120+.5*(a-p)+p,width:n,height:40,angle:o,isStatic:!0,color:3355443}).sprite.visible=!1;let i=Unicorn.AddOverlay("ground_segment_"+e,`ground_segment_${l(t.length)}`,.5*(e-c)+c,100+.5*(a-p)+p,{scale:{x:n/20,y:n/20}});i.rotation=o,i.anchor.set(.5,1),i.filters=[new PIXI.filters.NoiseFilter(.1)],c=e,p=a}d.push({x:0,y:r+100});var f=new PIXI.Graphics;f.beginFill(16777215),f.drawPolygon(d.map((e=>new PIXI.Point(e.x,e.y)))),f.endFill(),f.filters=[new PIXI.filters.NoiseFilter(.1)],groupOverlay.addChild(f),Matter.Events.on(physics,"beforeUpdate",(function(e){})),Matter.Events.on(physics,"afterUpdate",(function(e){for(var t in A)A[t].pet&&(A[t].pet.angle=A[t].player.angle,A[t].pet.position.x=Math.max(10,Math.min(i-10,A[t].player.position.x+A[t].petOffset)),A[t].pet.position.y=A[t].player.position.y+10)})),L=Unicorn.AddText("countdown_text","!hill to join",i/2,.025*r,{fontFamily:"Pixeltype",fontSize:80,fontWeight:"bold",fill:0,lineJoin:"round",stroke:"#ffffff",strokeThickness:6}),L.style.align="center",L.anchor.set(.5,0),(o.hideInstructions||o.hideTime)&&(L.text="")}function J(e,t){for(var n in w&&I.length<Object.keys(A).length&&(j+=t,o.hideTime||(L.text=(j/1e3).toFixed(3)+"s")),M>0&&(M-=t,o.hideTime?L.text="":o.hideInstructions?L.text=`Starting in ${Math.round(M/1e3)}s`:L.text=`!hill to join\n${Math.round(M/1e3)}s`,M<=0&&(o.hideTime||(L.text="0.000s"),C())),A)if(A[n].player)if(A[n].isLanded){let e=n===E?1:.3;A[n].end.alpha=A[n].label.alpha=e,A[n].pet&&(A[n].petEnd.alpha=e),A[n].scoreLabel.tint=A[n].label.tint=n===E?16777215:3355443,n===E?(A[n].end.zIndex=A[n].scoreLabel.zIndex=A[n].label.zIndex=9e3,A[n].pet&&(A[n].pet.zIndex=9001),A[n].label.position.x=A[n].player.position.x,A[n].label.position.y=A[n].player.position.y-80,A[n].scoreLabel.position.x=A[n].label.position.x+15,A[n].scoreLabel.position.y=A[n].label.position.y-30,A[n].label.style.fontSize=46,A[n].scoreLabel.style.fontSize=46,g.x=A[n].scoreLabel.x-A[n].scoreLabel.width/2-15,g.y=A[n].scoreLabel.y-5):(A[n].label.position.x=A[n].player.position.x,A[n].label.position.y=A[n].player.position.y-60,A[n].scoreLabel.position.y=A[n].label.position.y-30,A[n].scoreLabel.alpha=0,A[n].label.style.fontSize=40,A[n].scoreLabel.style.fontSize=40)}else{if(A[n].pet&&(A[n].pet.position.x=Math.max(20,Math.min(i-20,A[n].player.position.x+A[n].petOffset)),A[n].pet.position.y=A[n].player.position.y+20,A[n].petPara.position.x=A[n].pet.position.x,A[n].petPara.position.y=A[n].pet.position.y-30),A[n].player.position.y>r-46-50+(a.target_y_offset||0)){A[n].isLanded=!0,A[n].parachute.scale.x=A[n].parachute.scale.y=0,A[n].pet&&(A[n].petPara.scale.x=A[n].petPara.scale.y=0);let e=Unicorn.AddBacklay("end_"+n,A[n].player.endImage,A[n].player.position.x,A[n].player.position.y,{scale:{x:A[n].player.endScale,y:A[n].player.endScale}});if(A[n].player.animations&&(e.tint=A[n].player.animations.front.tint),e.anchor.set(.5),e.zIndex=20,I.push(n),A[n].player.isStatic=!0,A[n].score=j,A[n].rank=I.length,e.alpha=A[n].score>0?1:.3,A[n].end=e,A[n].pet){let e=Unicorn.AddBacklay("petend_"+n,`${A[n].petType}_front0`,A[n].pet.position.x,A[n].pet.position.y,{scale:{x:3,y:3}});A[n].pet.animations&&(e.tint=A[n].pet.animations.front.tint),e.anchor.set(.5),e.zIndex=30,A[n].pet.isStatic=!0,e.alpha=A[n].score>0?1:.3,A[n].petEnd=e}if(a.target_particles&&R(a.target_particles[0],a.target_particles[1],A[n].player.position.x,A[n].player.position.y+40,10),a.target_boosh&&F(A[n].player.position.x,A[n].player.position.y+40),a.target_sound&&Unicorn.PlaySound("sfx-target-drop",{volume:s}),console.log((j/1e3).toFixed(3)+"s",n,"finished",A[n].rank),1===A[n].rank&&(A[n].scoreLabel.x=A[n].label.position.x,A[n].scoreLabel.y=A[n].label.position.y-30,A[n].scoreLabel.text=(j/1e3).toFixed(3)+"s",E=n),A[n].rank<=10&&o.messageFormat){let e=o.messageFormat.replace("USERNAME",A[n].name).replace("RANK",A[n].rank).replace("TIME",(j/1e3).toFixed(3)+"s");setTimeout((()=>{ComfyJS.Say(e)}),5e3)}A[n].label.alpha=1===A[n].rank?1:.3,Unicorn.RemoveObject(A[n].player.label),Unicorn.RemoveBacklay("para_"+n),A[n].pet&&(Unicorn.RemoveObject(A[n].pet.label),Unicorn.RemoveBacklay("petpara_"+n))}else A[n].player.position.y<.5*-r||(A[n].parachute.scale.x=A[n].parachute.scale.y=0,A[n].pet&&(A[n].petPara.scale.x=A[n].petPara.scale.y=0));A[n].label.position.x=A[n].player.position.x,A[n].label.position.y=A[n].player.position.y-60}T.forEach(((e,a)=>{e.x-=t*e.speed,e.x+e.width/2<=0&&(e.x=i+e.width/2,e.y=l(500),e.speed=.01+.1*Math.random(),e.zIndex=e.speed)})),k.forEach((e=>{(e.vY<0||e.y<r-20)&&(e.x+=t/1e3*e.vX,e.y+=t/1e3*e.vY,e.vY<20&&(e.vY+=t/1e3*200))}))}